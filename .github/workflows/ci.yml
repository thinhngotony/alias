name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  lint:
    name: Lint Shell Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get install -y shellcheck

      - name: Lint Bash scripts
        run: |
          shellcheck install.sh
          shellcheck uninstall.sh
          shellcheck load.sh
          shellcheck aliases/*.sh

  syntax-check:
    name: Syntax Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Bash syntax
        run: |
          bash -n install.sh
          bash -n uninstall.sh
          bash -n load.sh
          bash -n aliases/git.sh
          bash -n aliases/k8s.sh
          bash -n aliases/system.sh

      - name: Check PowerShell syntax
        shell: pwsh
        run: |
          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile("$PWD/install.ps1", [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) { $errors | ForEach-Object { Write-Error $_ }; throw "install.ps1 has syntax errors" }

          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile("$PWD/uninstall.ps1", [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) { $errors | ForEach-Object { Write-Error $_ }; throw "uninstall.ps1 has syntax errors" }

          $errors = $null
          $null = [System.Management.Automation.Language.Parser]::ParseFile("$PWD/load.ps1", [ref]$null, [ref]$errors)
          if ($errors.Count -gt 0) { $errors | ForEach-Object { Write-Error $_ }; throw "load.ps1 has syntax errors" }

  test-install:
    name: Test Installation
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test install (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          # Run install script (ignore reload errors in CI)
          bash install.sh || true
          # Verify installation files exist
          test -f ~/.alias/load.sh
          test -f ~/.alias/env.sh
          test -d ~/.alias/custom
          # Verify shell config was updated
          grep -q "\.alias/load\.sh" ~/.bashrc || grep -q "\.alias/load\.sh" ~/.zshrc
          # Verify loader script is valid bash
          bash -n ~/.alias/load.sh

      - name: Test install (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Set execution policy for this process
          Set-ExecutionPolicy Bypass -Scope Process -Force
          # Set environment variable to skip policy check in install script
          $env:SKIP_POLICY_CHECK = "1"
          # Run install script
          . .\install.ps1
          # Verify installation
          if (-not (Test-Path ~\.alias\load.ps1)) { throw "load.ps1 not found" }
          if (-not (Test-Path ~\.alias\env.ps1)) { throw "env.ps1 not found" }
          if (-not (Test-Path ~\.alias\custom)) { throw "custom directory not found" }
          Write-Host "Windows installation verified successfully" -ForegroundColor Green

  release:
    name: Create Release
    needs: [lint, syntax-check, test-install]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          # Extract the section for this version from CHANGELOG.md
          # Matches from "## [x.y.z]" until the next "## [" or end of relevant content
          CHANGELOG=$(awk "/^## \[${VERSION#v}\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md | head -50)
          
          # Handle multiline output
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "CONTENT<<$EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Hyber Alias ${{ steps.version.outputs.VERSION }}
          body: |
            ## Release ${{ steps.version.outputs.VERSION }} ðŸš€

            ${{ steps.changelog.outputs.CONTENT }}

            ---

            ### Installation

            **Linux / macOS**
            ```bash
            bash <(curl -s https://raw.githubusercontent.com/thinhngotony/alias/main/install.sh)
            ```

            **Windows PowerShell**
            ```powershell
            iwr -useb https://raw.githubusercontent.com/thinhngotony/alias/main/install.ps1 | iex
            ```

            ### Features
            - One-command install/uninstall
            - Git aliases: `ga`, `gb`, `gc`/`gcm`, `gd`, `gs`, `gph`, `gpl`, `gsw`, `glog`, `gauto`
            - Kubernetes aliases: `k`, `ka`, `kd`, `kg`, `kgp`, `kgs`, `kl`, `ke`, `kctx`, `kns`
            - System aliases: `ll`, `la`, `cls`, `reload`, `home`, `..`, `...`
            - Custom alias support via `~/.alias/custom/`
            - Auto-update on shell start
            - Offline fallback with local cache
            - Cross-platform (Linux, macOS, Windows, WSL, Docker)
            - Bash, Zsh, and PowerShell support

            **Full Changelog**: https://github.com/thinhngotony/alias/compare/v1.0.0...${{ steps.version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
